{% extends "admin/base_site.html" %}
{% load i18n %}

{% block content %}
  <style>
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .metrics-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
    }
    .metrics-card h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }
    .metrics-pies {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .pie {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      background: conic-gradient(#2c6faa calc(var(--value) * 1%), #e6e6e6 0);
    }
    .pie small {
      position: absolute;
      bottom: -18px;
      width: 100%;
      text-align: center;
      font-size: 12px;
      color: #666;
    }
    .metrics-meta {
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }
  </style>

  <div class="metrics-grid" id="metrics-grid">
    {% for inst in instances %}
      <div class="metrics-card" data-instance-id="{{ inst.id }}">
        <h3>{{ inst.alias }}</h3>
        <div class="metrics-pies">
          <div class="pie" data-field="cpu" style="--value: {{ inst.last_cpu|default:0 }}">
            <span>{{ inst.last_cpu|default:0|floatformat:1 }}%</span>
            <small>CPU</small>
          </div>
          <div class="pie" data-field="memory" style="--value: {{ inst.last_memory|default:0 }}">
            <span>{{ inst.last_memory|default:0|floatformat:1 }}%</span>
            <small>内存</small>
          </div>
          <div class="pie" data-field="disk" style="--value: {{ inst.last_disk|default:0 }}">
            <span>{{ inst.last_disk|default:0|floatformat:1 }}%</span>
            <small>磁盘</small>
          </div>
        </div>
        <div class="metrics-meta">
          最新时间：{{ inst.last_timestamp|date:"Y-m-d H:i:s" }}
        </div>
      </div>
    {% empty %}
      <div>暂无实例指标</div>
    {% endfor %}
  </div>

  <script>
    function updatePie(el, value) {
      var v = Number(value || 0);
      if (v < 0) v = 0;
      if (v > 100) v = 100;
      el.style.setProperty('--value', v);
      var label = el.querySelector('span');
      if (label) {
        label.textContent = v.toFixed(1) + '%';
      }
    }

    async function refreshMetrics() {
      var url = "{{ realtime_url }}";
      try {
        var res = await fetch(url, { credentials: 'same-origin' });
        var data = await res.json();
        if (!data.success) {
          return;
        }
        data.data.forEach(function (item) {
          var card = document.querySelector('[data-instance-id=\"' + item.id + '\"]');
          if (!card) return;
          card.querySelectorAll('.pie').forEach(function (pie) {
            var field = pie.getAttribute('data-field');
            updatePie(pie, item[field]);
          });
          var meta = card.querySelector('.metrics-meta');
          if (meta && item.timestamp) {
            meta.textContent = '最新时间：' + item.timestamp.replace('T', ' ').replace('Z', '');
          }
        });
      } catch (err) {
        console.error(err);
      }
    }

    setInterval(refreshMetrics, 10000);
  </script>
{% endblock %}
