{% extends "admin/base_site.html" %}

{% block content %}
  <style>
    .sql-terminal-title {
      white-space: nowrap;
    }
    .sql-terminal-form .inline-fields {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .sql-terminal-form .inline-fields > div {
      flex: 1 1 240px;
      min-width: 220px;
    }
    .terminal-box {
      background: #111;
      color: #e5e5e5;
      padding: 12px;
      border-radius: 6px;
      font-family: Consolas, monospace;
      display: flex;
      flex-direction: column;
      min-height: 280px;
      max-height: 480px;
    }
    .terminal-output {
      flex: 1 1 auto;
      overflow: auto;
      padding-right: 4px;
    }
    .terminal-input-row {
      display: flex;
      gap: 8px;
      border-top: 1px solid #2b2b2b;
      margin-top: 10px;
      padding-top: 8px;
    }
    .terminal-prompt {
      color: #9cc8ff;
      padding-top: 3px;
    }
    .terminal-input {
      flex: 1 1 auto;
      background: transparent;
      color: inherit;
      border: none;
      outline: none;
      resize: none;
      font-family: inherit;
      min-height: 72px;
    }
    .terminal-hint {
      margin-top: 6px;
      color: #666;
    }
  </style>

  <h1 class="sql-terminal-title">SQL 终端</h1>
  <p>执行结果会自动记录到“SQL 执行历史”。</p>

  <form id="sql-terminal-form" class="sql-terminal-form" method="post" novalidate>
    {% csrf_token %}
    <input type="hidden" name="sql" id="terminal-sql">
    <fieldset class="module aligned">
      <div class="form-row inline-fields">
        <div>
          {{ form.instance.label_tag }}
          {{ form.instance }}
        </div>
        <div>
          {{ form.database.label_tag }}
          {{ form.database }}
        </div>
      </div>
      <details style="margin-top: 8px;">
        <summary>高级设置</summary>
        <div class="form-row">
          <div>
            {{ form.timeout.label_tag }}
            {{ form.timeout }}
          </div>
        </div>
        <div class="form-row">
          <div>
            {{ form.apply_limit.label_tag }}
            {{ form.apply_limit }}
          </div>
        </div>
        <div class="form-row">
          <div>
            {{ form.max_rows.label_tag }}
            {{ form.max_rows }}
          </div>
        </div>
      </details>
    </fieldset>
    <div class="submit-row">
      <a href="{{ history_url }}" class="button">查看执行历史</a>
    </div>
  </form>

  <div id="sql-terminal" style="margin-top: 16px;">
    <div class="terminal-box">
      <div id="terminal-output" class="terminal-output"></div>
      <div class="terminal-input-row">
        <div class="terminal-prompt">&gt;</div>
        <textarea id="terminal-input" class="terminal-input" rows="3" placeholder="输入 SQL，回车执行，Shift+Enter 换行"></textarea>
      </div>
    </div>
    <div class="terminal-hint">
      快捷键：Enter 执行，Shift+Enter 换行，↑/↓ 切换历史命令
    </div>
  </div>

  <script>
    (function () {
      const form = document.getElementById('sql-terminal-form');
      const sqlField = document.getElementById('terminal-sql');
      const output = document.getElementById('terminal-output');
      const input = document.getElementById('terminal-input');
      const executeUrl = "{{ execute_url }}";
      const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
      const history = [];
      let historyIndex = -1;

      function appendLine(text, cls) {
        const line = document.createElement('div');
        if (cls) {
          line.className = cls;
        }
        line.textContent = text;
        output.appendChild(line);
        output.scrollTop = output.scrollHeight;
      }

      function appendBlock(text) {
        const pre = document.createElement('pre');
        pre.style.margin = '6px 0';
        pre.style.whiteSpace = 'pre-wrap';
        pre.textContent = text;
        output.appendChild(pre);
        output.scrollTop = output.scrollHeight;
      }

      function toCellValue(value) {
        if (value === null || value === undefined) {
          return 'NULL';
        }
        if (typeof value === 'boolean') {
          return value ? '1' : '0';
        }
        return String(value);
      }

      function padRight(text, width) {
        return text + ' '.repeat(Math.max(0, width - text.length));
      }

      function formatTable(columns, rows) {
        if (!columns || !columns.length) {
          return '';
        }
        const widths = columns.map((col) => col.length);
        rows.forEach((row) => {
          columns.forEach((col, idx) => {
            const value = toCellValue(row[col]);
            widths[idx] = Math.max(widths[idx], value.length);
          });
        });

        const separator = '+' + widths.map((w) => '-'.repeat(w + 2)).join('+') + '+';
        const header = '|' + columns.map((col, idx) => ` ${padRight(col, widths[idx])} `).join('|') + '|';
        const lines = [separator, header, separator];

        rows.forEach((row) => {
          const line = '|' + columns.map((col, idx) => ` ${padRight(toCellValue(row[col]), widths[idx])} `).join('|') + '|';
          lines.push(line);
        });
        lines.push(separator);
        return lines.join('\n');
      }

      function renderResult(result) {
        if (!result || !result.success) {
          appendLine(`ERROR: ${result && result.message ? result.message : '执行失败'}`);
          if (result && result.errors) {
            appendBlock(JSON.stringify(result.errors, null, 2));
          }
          return;
        }

        if (result.columns && result.columns.length) {
          const table = formatTable(result.columns, result.data || []);
          if (table) {
            appendBlock(table);
          }
        }

        const seconds = (result.execution_time_ms / 1000).toFixed(2);
        const rows = result.rows_affected || 0;
        if (['SELECT', 'SHOW', 'DESC', 'EXPLAIN'].includes(result.sql_type)) {
          appendLine(`${rows} rows in set (${seconds} sec)`);
        } else {
          appendLine(`${rows} rows affected (${seconds} sec)`);
        }

        if (result.warnings && result.warnings.length) {
          result.warnings.forEach((warning) => appendLine(`Warning: ${warning}`));
        }
      }

      async function executeSql(sql) {
        sqlField.value = sql;
        const data = new URLSearchParams(new FormData(form));
        const response = await fetch(executeUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken
          },
          body: data
        });
        const result = await response.json();
        return result;
      }

      async function runCommand() {
        const sql = input.value.trim();
        if (!sql) {
          return;
        }
        history.push(sql);
        historyIndex = history.length;
        input.value = '';
        appendLine(`> ${sql}`, 'cmd');

        try {
          const result = await executeSql(sql);
          renderResult(result);
        } catch (err) {
          appendLine(`ERROR: ${err}`);
        }
      }

      input.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          runCommand();
        } else if (event.key === 'ArrowUp') {
          if (history.length === 0) return;
          event.preventDefault();
          historyIndex = Math.max(0, historyIndex - 1);
          input.value = history[historyIndex];
        } else if (event.key === 'ArrowDown') {
          if (history.length === 0) return;
          event.preventDefault();
          historyIndex = Math.min(history.length, historyIndex + 1);
          input.value = historyIndex === history.length ? '' : history[historyIndex];
        }
      });
    })();
  </script>
{% endblock %}
