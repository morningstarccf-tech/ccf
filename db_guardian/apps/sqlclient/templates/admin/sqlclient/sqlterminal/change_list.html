{% extends "admin/base_site.html" %}

{% block content %}
  <h1>SQL 终端</h1>
  <p>执行结果会自动记录到“SQL执行历史”。</p>

  <form id="sql-terminal-form" method="post" novalidate>
    {% csrf_token %}
    <fieldset class="module aligned">
      {{ form.as_p }}
    </fieldset>
    <div class="submit-row">
      <a href="{{ history_url }}" class="button">查看执行历史</a>
    </div>
  </form>

  <div id="sql-terminal" style="margin-top: 16px;">
    <div id="terminal-output" style="background: #111; color: #e5e5e5; padding: 12px; min-height: 240px; max-height: 420px; overflow: auto; font-family: Consolas, monospace; border-radius: 4px;"></div>
    <textarea id="terminal-input" rows="4" style="width: 100%; margin-top: 10px; font-family: Consolas, monospace;" placeholder="输入 SQL，回车执行，Shift+Enter 换行"></textarea>
    <div style="margin-top: 6px; color: #666;">
      快捷键：Enter 执行，Shift+Enter 换行，↑/↓ 切换历史命令
    </div>
  </div>

  <script>
    (function () {
      const form = document.getElementById('sql-terminal-form');
      const output = document.getElementById('terminal-output');
      const input = document.getElementById('terminal-input');
      const executeUrl = "{{ execute_url }}";
      const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
      const history = [];
      let historyIndex = -1;

      function appendLine(text, cls) {
        const line = document.createElement('div');
        if (cls) {
          line.className = cls;
        }
        line.textContent = text;
        output.appendChild(line);
        output.scrollTop = output.scrollHeight;
      }

      function appendBlock(text) {
        const pre = document.createElement('pre');
        pre.style.margin = '6px 0';
        pre.style.whiteSpace = 'pre-wrap';
        pre.textContent = text;
        output.appendChild(pre);
        output.scrollTop = output.scrollHeight;
      }

      async function executeSql(sql) {
        const data = new URLSearchParams(new FormData(form));
        data.set('sql', sql);
        const response = await fetch(executeUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken
          },
          body: data
        });
        const result = await response.json();
        return result;
      }

      async function runCommand() {
        const sql = input.value.trim();
        if (!sql) {
          return;
        }
        history.push(sql);
        historyIndex = history.length;
        input.value = '';
        appendLine(`> ${sql}`, 'cmd');

        try {
          const result = await executeSql(sql);
          if (result.success) {
            appendLine(`OK (${result.sql_type}) rows=${result.rows_affected} time=${result.execution_time_ms}ms`);
            if (result.columns && result.columns.length) {
              appendLine(`Columns: ${result.columns.join(', ')}`);
            }
            if (result.data && result.data.length) {
              const sliced = result.data.slice(0, 50);
              appendBlock(JSON.stringify(sliced, null, 2));
              if (result.data.length > 50) {
                appendLine(`... 已截断，仅显示前 50 行`);
              }
            }
          } else {
            appendLine(`ERROR: ${result.message || '执行失败'}`);
            if (result.errors) {
              appendBlock(JSON.stringify(result.errors, null, 2));
            }
          }
        } catch (err) {
          appendLine(`ERROR: ${err}`);
        }
      }

      input.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          runCommand();
        } else if (event.key === 'ArrowUp') {
          if (history.length === 0) return;
          event.preventDefault();
          historyIndex = Math.max(0, historyIndex - 1);
          input.value = history[historyIndex];
        } else if (event.key === 'ArrowDown') {
          if (history.length === 0) return;
          event.preventDefault();
          historyIndex = Math.min(history.length, historyIndex + 1);
          input.value = historyIndex === history.length ? '' : history[historyIndex];
        }
      });
    })();
  </script>
{% endblock %}
