
# **一体化MySQL数据库管理与备份平台 (DB-Guardian) 后端服务需求规格说明书**

| **版本** | **日期**   | **作者**     | **修订说明**                                                                                                                          |
| :------- | :--------- | :----------- | :------------------------------------------------------------------------------------------------------------------------------------ |
| V2.1     | 2025-11-13 | Gemini       | 1. 明确为前后端分离架构的后端需求。<br>2. 新增开发环境与技术栈规约。<br>3. **更新环境管理规约为现代uv工作流 (`uv add`, `uv sync`)。** |
| V2.2     | 2025-12-01 | AI Assistant | 1. 根据可行性分析结果调整Python版本为3.11 LTS。<br>2. 保持uv作为依赖管理工具。                                                        |

## 1. 引言

### 1.1 项目背景
随着业务数据的爆炸式增长，对MySQL数据库的日常管理、性能监控和数据安全保障提出了更高的要求。传统的命令行工具或分散的管理软件效率低下且易出错。本项目旨在开发一个Web化、集中式的一体化MySQL管理平台的**后端服务**，借鉴阿里云PolarDB等成熟产品的设计理念，**为独立的前端应用提供稳定、安全、高效的API接口**。

### 1.2 文档目的
本文档旨在详细阐述“DB-Guardian”平台**后端服务**的功能性与非功能性需求，作为后续API设计、开发、测试和验收的核心依据。**前端应用的界面设计与实现不在本文档的讨论范围之内。**

### 1.3 目标用户
*   **超级管理员：** 负责整个平台的维护、用户与权限体系的管理。
*   **团队/项目管理员：** 负责管理其团队内的用户、分配资源（数据库实例）和权限。
*   **开发/运维工程师：** 平台的主要使用者，负责数据库的日常管理、监控、备份恢复和SQL操作。

## 2. 系统总体描述

### 2.1 产品愿景
打造一款可私有化部署、企业级的数据库管理工具的后端核心，通过提供自动化的备份策略和精细化的权限管控API，保障数据安全；通过提供可视化的监控数据和便捷的在线管理API，为前端应用赋能，最终提升数据库运维效率。

### 2.2 系统架构概览
系统将采用**前后端分离**的现代Web架构。后端服务完全基于Django和Django Rest Framework构建，负责所有业务逻辑、数据处理和持久化，并通过一套标准化的**RESTful API**向外提供服务。

```mermaid
graph LR
    subgraph "客户端 (范围外)"
        FrontendApp[前端应用<br>(React/Vue in Browser)]
    end

    subgraph "服务端 (本项目范围)"
        Nginx[Nginx 反向代理] --> Web(Django/Gunicorn API服务);
        Web -- API读写 --> AppDB[(PostgreSQL)];
        Web -- 发布任务 --> Redis((Redis));
        
        Worker[Celery Worker] -- 获取任务 --> Redis;
        Beat[Celery Beat] -- 调度 --> Redis;
        
        Worker -- 操作 --> TargetDBs[目标MySQL实例];
        Worker -- 写结果 --> AppDB;
    end

    FrontendApp -- API Calls (HTTPS) --> Nginx;
```

## 3. 功能性需求 (API-Centric)

### 模块一：用户与权限中心 (RBAC)

| **ID**     | **功能名称**   | **API描述**                                                       | **面向角色**           | **核心需求点**                                                                                                                        |
| :--------- | :------------- | :---------------------------------------------------------------- | :--------------------- | :------------------------------------------------------------------------------------------------------------------------------------ |
| FR-AUTH-01 | **用户管理**   | 提供`users/`系列API，支持对用户的增、删、改、查操作。             | 超级管理员             | 1. 提供获取用户列表的API，支持按用户名、团队等条件搜索和筛选。<br>2. 创建用户的API需接收初始密码和所属团队ID。                        |
| FR-AUTH-02 | **角色与权限** | 提供`roles/`和`permissions/`系列API，管理角色及其权限。           | 超级管理员             | 1. 提供API以查询内置角色及其权限。<br>2. 提供API以修改角色绑定的权限列表。                                                            |
| FR-AUTH-03 | **团队管理**   | 提供`teams/`系列API，管理团队、成员及成员角色。                   | 超级管理员, 团队管理员 | 1. 超级管理员可调用API创建团队并指派团队管理员。<br>2. 团队管理员可调用API管理团队成员及其在团队内的角色。                            |
| FR-AUTH-04 | **登录与认证** | 提供`/api/token/`和`/api/token/refresh/`端点，实现基于JWT的认证。 | 所有用户               | 1. 登录API接收用户名和密码，成功后返回`access_token`和`refresh_token`。<br>2. 所有需要认证的API请求头中必须携带有效的`access_token`。 |

### 模块二：数据库实例管理

| **ID**     | **功能名称**       | **API描述**                                                          | **面向角色**         | **核心需求点**                                                                                                                                                                                   |
| :--------- | :----------------- | :------------------------------------------------------------------- | :------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| FR-INST-01 | **纳管新实例**     | 提供`POST /instances/` API，用于录入新的数据库实例。                 | 团队管理员, 开发人员 | 1. API应接收包含别名、Host、Port、用户名、密码、团队ID的JSON负载。<br>2. **【安全】** 密码在存入数据库前必须被加密。<br>3. 提供独立的`/instances/test-connection/` API端点，用于验证连接有效性。 |
| FR-INST-02 | **实例列表**       | 提供`GET /instances/` API，返回用户有权访问的实例列表。              | 所有用户             | 1. API返回数据应包含实例ID、别名、连接地址、状态（通过后台任务刷新）。<br>2. 支持分页、排序和按别名搜索。                                                                                        |
| FR-INST-03 | **实例仪表盘数据** | 提供`/instances/{id}/dashboard/` API，返回指定实例的监控和概览数据。 | 团队管理员, 开发人员 | 1. API返回内容应结构化，包含**概览信息**和**性能时序数据**（如QPS, TPS等）。<br>2. 提供`/instances/{id}/databases/` API，用于管理实例下的数据库。                                                |

### 模块三：备份与恢复中心

| **ID**     | **功能名称**     | **API描述**                                                    | **面向角色**         | **核心需求点**                                                                                                                                    |
| :--------- | :--------------- | :------------------------------------------------------------- | :------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------ |
| FR-BKUP-01 | **备份策略管理** | 提供`strategies/`系列API，用于增删改查备份策略。               | 团队管理员, 开发人员 | 1. 创建/更新策略的API需接收关联实例ID、Cron表达式、保留策略等参数。<br>2. API应能触发后台`celery-beat`任务的动态更新。                            |
| FR-BKUP-02 | **手动备份**     | 提供`POST /instances/{id}/backup/` API，立即触发一次备份任务。 | 团队管理员, 开发人员 | 1. 调用此API会创建一个异步备份任务。<br>2. API应立即返回任务ID，前端可通过该ID轮询任务状态。                                                      |
| FR-BKUP-03 | **备份历史**     | 提供`GET /backups/` API，查询备份任务历史记录。                | 团队管理员, 开发人员 | 1. API支持按实例ID进行过滤。<br>2. 返回的每条记录都包含下载链接、文件大小、状态等信息。<br>3. 提供`DELETE /backups/{id}/` API删除备份记录及文件。 |
| FR-BKUP-04 | **数据恢复**     | 提供`POST /backups/{id}/restore/` API，从指定备份执行恢复。    | 团队管理员           | 1. **【安全】** 此API必须接收一个额外的确认参数（如`"confirm": true`），以防误操作。<br>2. 后端逻辑在执行前会再次校验操作者的权限。               |

### 模块四：在线SQL管理 (Web SQL Client)

| **ID**    | **功能名称**     | **API描述**                                                      | **面向角色** | **核心需求点**                                                                                                                                                                           |
| :-------- | :--------------- | :--------------------------------------------------------------- | :----------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| FR-SQL-01 | **模式浏览器**   | 提供`/instances/{id}/schema/` API，返回数据库的树状结构元数据。  | 开发人员     | 1. API响应应为层级化的JSON，方便前端渲染为树状视图。                                                                                                                                     |
| FR-SQL-02 | **安全查询执行** | 提供`POST /instances/{id}/query/` API，用于执行SQL语句。         | 开发人员     | 1. API接收包含SQL语句的JSON负载。<br>2. **【安全】** 后端执行前，需通过`sqlparse`库解析SQL，并根据用户权限进行命令类型校验。<br>3. **【性能】** 自动对SELECT查询应用行数限制和执行超时。 |
| FR-SQL-03 | **结果导出**     | 提供`GET /query-results/{result_id}/export/` API，导出查询结果。 | 开发人员     | 1. 在执行查询后，如果数据量较大，可将结果缓存，并提供一个结果ID。<br>2. 此API根据结果ID和指定的格式（如CSV）生成并返回文件流。                                                           |

## 4. 非功能性需求 (Non-Functional Requirements)

| **ID** | **类别**     | **需求描述**                                                                                                                                                                                                                                         |
| :----- | :----------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| NFR-01 | **性能**     | 1. 核心API（如获取实例列表）的P95响应时间应在500ms以内。<br>2. 异步任务的调度和执行延迟应在可接受范围内。<br>3. 系统应能稳定支持至少50个数据库实例的并发监控数据采集。                                                                               |
| NFR-02 | **安全**     | 1. **数据存储**：所有数据库连接密码、敏感配置必须加密存储。<br>2. **API安全**：所有API需进行认证和授权检查。防范CSRF、XSS（通过CORS策略）、SQL注入等常见Web攻击。<br>3. **日志审计**：对登录、高危操作（如恢复、删除实例）等行为记录详细的操作日志。 |
| NFR-03 | **可用性**   | 1. API服务应设计为无状态，便于水平扩展。<br>2. 异步任务失败后，应有重试机制，并提供API查询失败原因。                                                                                                                                                 |
| NFR-04 | **可维护性** | 1. API应遵循RESTful设计规范，提供清晰、一致的接口。<br>2. 提供Swagger或OpenAPI格式的API文档。                                                                                                                                                        |

## 5. 开发与环境规约

### 5.1 技术栈 (Backend)
*   **编程语言:** **Python 3.11**
*   **Web框架:** Django, Django Rest Framework
*   **异步任务:** Celery, Django Celery Beat
*   **数据库 (应用):** PostgreSQL
*   **消息队列 & 缓存:** Redis

### 5.2 **环境管理 (uv)**
*   **工具:** **uv**
*   **规约:**
    *   项目将完全采用 `uv` 进行现代化的Python环境与依赖管理。
    *   项目依赖将统一在 `pyproject.toml` 文件中进行声明。
    *   **添加新依赖：** 使用 `uv add <package-name>` 命令。此操作会自动更新 `pyproject.toml` 文件。
    *   **安装/同步环境：** 在创建虚拟环境后，使用 `uv sync` 命令来安装所有项目依赖。此命令可确保开发、测试和生产环境的一致性与可复现性。
    *   **摒弃传统方式：** 本项目将**不再**使用 `requirements.txt` 文件和 `pip` 命令进行依赖管理。
    *   **版本说明:** 使用 Python 3.11 LTS 版本,确保生产环境稳定性和长期支持。
    *   **备选方案:** 虽然使用 uv 作为主要依赖管理工具,但建议在 CI/CD 流程中准备 Poetry 作为备选方案。

### 5.3 容器化部署
*   项目必须提供功能完善的 `Dockerfile` 和 `docker-compose.yml` 文件，用于构建后端服务、Celery Worker、Celery Beat、数据库、Redis等所有组件的镜像，并支持一键化启动整个后端环境。