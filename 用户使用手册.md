# AuroraVault 用户使用手册（详细版）

> 适用对象：首次接触本项目的普通用户 / 运维新手
> 
> 本手册以“能跑起来、能用、能排错”为目标，提供 Windows 与 Linux 的详细部署与使用说明。

---

## 1. 项目简介
AuroraVault 是一个面向 MySQL 的**备份与运维管理平台**，提供：
- 实例管理（MySQL 实例接入/状态检测）
- 备份策略（全量/增量/热备/冷备）
- 备份记录与恢复
- SQL 终端与执行历史
- 权限与团队管理

前端地址：
- **主界面（推荐使用）**：`http://127.0.0.1:8000/admin/`
- Django 原生后台（开发/排错用）：`http://127.0.0.1:8000/x-admin/`

---

## 2. 部署方式总览
支持 2 种模式：

### 2.1 Docker 部署（推荐）
- 适合大多数用户
- 一键启动，环境一致
- Windows / Linux 都适用

### 2.2 本地部署（非 Docker）
- 适合调试、二次开发
- 需要自己安装 PostgreSQL、Redis

---

## 3. Windows 部署（Docker 方式）

### 3.1 安装必要软件
1. 安装 **Docker Desktop**（必须启用 WSL2）
2. 重启电脑（如系统提示）
3. 确保 `docker` 和 `docker compose` 命令可用

### 3.2 启动项目
> 在 Windows 终端（PowerShell）执行

```powershell
cd F:\gold\ccf\db_guardian

# 复制配置文件
Copy-Item .env.example .env

# 启动服务
Docker compose up -d
```

### 3.3 初始化数据库
```powershell
Docker compose exec -T web uv run python manage.py migrate
Docker compose exec -T web uv run python manage.py createsuperuser
Docker compose exec -T web uv run python manage.py collectstatic --noinput
```

### 3.4 访问系统
打开浏览器访问：
- `http://127.0.0.1:8000/admin/`
使用刚创建的管理员账号登录。

---

## 4. Linux 部署（Docker 方式）

### 4.1 安装 Docker 与 Compose
```bash
sudo apt update
sudo apt install -y docker.io docker-compose-plugin
sudo systemctl enable --now docker
```

### 4.2 启动项目
```bash
cd /path/to/ccf/db_guardian
cp .env.example .env

docker compose up -d
```

### 4.3 初始化数据库
```bash
docker compose exec -T web uv run python manage.py migrate
Docker compose exec -T web uv run python manage.py createsuperuser
Docker compose exec -T web uv run python manage.py collectstatic --noinput
```

### 4.4 访问系统
浏览器打开：
- `http://服务器IP:8000/admin/`

---

## 5. Linux / Windows 非 Docker 部署（本地运行）

### 5.1 依赖环境
- Python 3.11+
- PostgreSQL 15+
- Redis 7+
- UV（推荐）

### 5.2 安装依赖
```bash
cd db_guardian
uv sync
```

### 5.3 配置环境变量
复制并编辑：
```
cp .env.example .env
```

### 5.4 数据库初始化
```bash
uv run python manage.py migrate
uv run python manage.py createsuperuser
uv run python manage.py collectstatic --noinput
```

### 5.5 启动服务
```bash
uv run python manage.py runserver 0.0.0.0:8000
uv run celery -A tasks worker -l info
uv run celery -A tasks beat -l info
```

---

## 6. 必填配置说明（最重要）

打开 `db_guardian/.env`，注意以下变量：

| 变量 | 说明 |
|------|------|
| `SECRET_KEY` | Django 密钥 |
| `ENCRYPTION_KEY` | **必须**，用于加密保存 MySQL 密码 |
| `DB_HOST/PORT/NAME/USER/PASSWORD` | PostgreSQL 连接 |
| `REDIS_CACHE_URL` | Redis 地址 |
| `CELERY_BROKER_URL` | Celery 连接 |

> 如果没有 `ENCRYPTION_KEY`，系统会拒绝启动。

---

## 7. 功能使用指南（新手必读）

### 7.1 创建团队
登录后进入：**认证管理 → 团队 → 新增团队**

### 7.2 添加 MySQL 实例
进入：**实例列表 → 新增实例**

必须填写：
- 别名
- 主机 IP
- 端口
- 用户名 / 密码
- 团队
- 部署方式

#### 如果 MySQL 在 Docker 中：
- 填写 **容器名称**

#### 如果 MySQL 在系统服务：
- 填写 **服务名称**（如 `mysql` 或 `mysqld`）

#### 如果要启用监控/备份：
还需填写 SSH 信息（用于远程执行命令）：
- SSH 主机
- SSH 用户
- SSH 密码或密钥

---

## 8. 备份管理说明

### 8.1 备份策略
进入：**备份管理 → 备份策略 → 新增策略**

常用字段：
- 备份类型（全量/增量/热备/冷备）
- Cron 表达式（例如：`0 */6 * * *` 表示每 6 小时）
- 保留天数
- 存储位置

### 8.2 定时任务（一次性）
进入：**备份管理 → 定时任务 → 新增任务**

### 8.3 备份记录
查看所有已执行的备份，可以下载、验证或恢复。

### 8.4 恢复
- **从备份记录恢复**：直接点击“恢复”按钮
- **上传备份文件恢复**：手动上传 `.sql` / `.sql.gz`

---

## 9. SQL 终端使用说明
进入：**SQL 终端**

- 选择实例和数据库
- 输入 SQL
- 回车执行（Shift+Enter 换行）

执行历史会自动记录到 **SQL 执行历史**

---

## 10. 常见问题（FAQ）

### Q1: CPU/内存显示为 0？
A: 必须配置 SSH 登录信息，系统通过 SSH 采集监控。

### Q2: 备份失败提示 mysqldump 不存在？
A: Docker 镜像中需安装 `mariadb-client` 或 `mysql-client`。

### Q3: 热备/增量不工作？
A: 目标主机必须安装 `xtrabackup`。

---

## 11. 重要提示
- **务必保存 ENCRYPTION_KEY**
- 备份/恢复操作建议在测试库先试
- 生产建议使用 Linux + Docker 部署

---

如需进一步指导，请反馈错误信息或截图。
