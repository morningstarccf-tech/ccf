# AuroraVault 用户使用手册（详细版）

> 适用对象：首次接触本项目的普通用户 / 运维新手
> 
> 本手册以“能跑起来、能用、能排错”为目标，提供 Windows 与 Linux 的详细部署与使用说明。

---

## 1. 项目简介
AuroraVault 是一个面向 MySQL 的**备份与运维管理平台**，提供：
- 实例管理（MySQL 实例接入/状态检测）
- 备份策略（全量/增量/热备/冷备）
- 备份记录与恢复
- SQL 终端与执行历史
- 权限与团队管理

前端地址：
- **主界面（推荐使用）**：`http://127.0.0.1:8000/admin/`
- Django 原生后台（开发/排错用）：`http://127.0.0.1:8000/x-admin/`

---

## 2. 部署方式总览
支持 2 种模式：

### 2.1 Docker 部署（推荐）
- 适合大多数用户
- 一键启动，环境一致
- Windows / Linux 都适用

### 2.2 本地部署（非 Docker）
- 适合调试、二次开发
- 需要自己安装 PostgreSQL、Redis

---

## 3. 部署角色与依赖清单（务必看）
本系统通常涉及 **两类服务器**：

### 3.1 应用服务器（部署 AuroraVault 的机器）
**必须具备：**
- Docker 部署：Docker + Docker Compose
- 非 Docker 部署：Python 3.11+、PostgreSQL 15+、Redis 7+、UV（或 pip）

**建议具备：**
- Nginx（反向代理）
- Git（更新代码）

**端口建议放行：**
- 8000（Web 访问）
- 5432（PostgreSQL，如果本机部署）
- 6379（Redis，如果本机部署）

### 3.2 被管理的 MySQL 服务器（目标数据库所在机器）
本系统会通过 SSH 或容器命令访问该服务器，因此目标服务器**必须准备好以下内容**：

**必须具备：**
- MySQL 服务（容器或系统服务）
- 可通过网络访问（IP/端口开放）

**如需监控指标（CPU/内存/磁盘）：**
- SSH 服务（sshd）
- 提供 SSH 账号（有权限执行 `top/free/df`）

**如需备份：**
- `mysqldump`（全量备份依赖）
- `xtrabackup`（热备/增量依赖）
- 冷备份需要能够停止/启动 MySQL（docker 或 systemd）

**常见依赖命令：**
```
mysqldump
xtrabackup
ssh/sshd
systemctl 或 docker
```

---

## 4. Windows 部署（Docker 方式）

### 4.1 安装必要软件
1. 安装 **Docker Desktop**（必须启用 WSL2）
2. 重启电脑（如系统提示）
3. 确保 `docker` 和 `docker compose` 命令可用

### 4.2 获取项目代码
方式一：直接拷贝项目目录到本机  
方式二：使用 Git 克隆（示例）：  
```powershell
git clone <你的仓库地址>
```

### 4.3 启动项目
> 在 Windows 终端（PowerShell）执行

```powershell
cd F:\gold\ccf\db_guardian

# 复制配置文件
Copy-Item .env.example .env

# 启动服务
Docker compose up -d
```

### 4.4 初始化数据库
```powershell
Docker compose exec -T web uv run python manage.py migrate
Docker compose exec -T web uv run python manage.py createsuperuser
Docker compose exec -T web uv run python manage.py collectstatic --noinput
```

### 4.5 访问系统
打开浏览器访问：
- `http://127.0.0.1:8000/admin/`
使用刚创建的管理员账号登录。

---

## 5. Linux 部署（Docker 方式，CentOS）

### 5.1 安装 Docker 与 Compose（CentOS 7/8/Stream）
> 以下命令以 **CentOS** 为主（使用 yum/dnf）。

**CentOS 7：**
```bash
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
sudo systemctl enable --now docker
```

**CentOS 8 / Stream：**
```bash
sudo dnf install -y dnf-utils
sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
sudo systemctl enable --now docker
```

### 5.2 获取项目代码
方式一：直接上传项目目录到服务器  
方式二：使用 Git 克隆（示例）：  
```bash
git clone <你的仓库地址>
```

### 5.3 启动项目
```bash
cd /path/to/ccf/db_guardian
cp .env.example .env

docker compose up -d
```

### 5.4 初始化数据库
```bash
docker compose exec -T web uv run python manage.py migrate
Docker compose exec -T web uv run python manage.py createsuperuser
Docker compose exec -T web uv run python manage.py collectstatic --noinput
```

### 5.5 访问系统
浏览器打开：
- `http://服务器IP:8000/admin/`

---

### 5.6 防火墙与系统设置（CentOS）
如果使用 firewalld，请放行端口：
```bash
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --reload
```

可选：允许普通用户免 sudo 使用 Docker：
```bash
sudo usermod -aG docker $USER
# 重新登录后生效
```

---

## 6. Linux / Windows 非 Docker 部署（本地运行）

### 6.1 依赖环境
- Python 3.11+
- PostgreSQL 15+
- Redis 7+
- UV（推荐）

### 6.2 安装依赖
```bash
cd db_guardian
uv sync
```

### 6.3 配置环境变量
复制并编辑：
```
cp .env.example .env
```

### 6.4 数据库初始化
```bash
uv run python manage.py migrate
uv run python manage.py createsuperuser
uv run python manage.py collectstatic --noinput
```

### 6.5 启动服务
```bash
uv run python manage.py runserver 0.0.0.0:8000
uv run celery -A tasks worker -l info
uv run celery -A tasks beat -l info
```

---

### 6.6 CentOS 非 Docker 部署（更详细）
> CentOS 建议优先使用 Docker，非 Docker 部署需额外准备依赖。

**安装 Python 3.11（示例）**
- CentOS 8/Stream 可直接安装：
```bash
sudo dnf install -y python3.11 python3.11-devel
```
- CentOS 7 建议使用 `pyenv` 或源码编译（略）。

**安装 PostgreSQL 15（使用官方仓库）**
```bash
sudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
sudo yum install -y postgresql15-server postgresql15
sudo /usr/pgsql-15/bin/postgresql-15-setup initdb
sudo systemctl enable --now postgresql-15
```

**安装 Redis**
```bash
sudo yum install -y epel-release
sudo yum install -y redis
sudo systemctl enable --now redis
```

**安装 UV**
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

---

## 7. 目标 MySQL 服务器准备（非常关键）
> AuroraVault 需要能远程访问 MySQL 服务器并执行备份/监控命令。

### 7.1 必须具备
- MySQL 正常运行（容器或系统服务）  
- SSH 可登录（监控/备份需要）  

### 7.2 必须安装的工具
**全量备份：**
```bash
mysqldump
```

**热备 / 增量备份：**
```bash
xtrabackup
```

### 7.3 CentOS 安装示例（目标 MySQL 服务器）
```bash
sudo yum install -y openssh-server
sudo systemctl enable --now sshd

# 安装 Percona XtraBackup（以 CentOS 7 为例）
sudo yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm
sudo percona-release setup pxb-80
sudo yum install -y percona-xtrabackup-80
```

### 7.4 冷备份注意事项
冷备份需要 **停库**：
- Docker MySQL：需要 `docker stop <容器名>` 权限  
- 系统服务 MySQL：需要 `systemctl stop mysql` 权限  

### 7.5 监控指标采集
- CPU/内存/磁盘数据通过 SSH 获取  
- 需要目标主机可执行 `top/free/df`  

---

## 8. 必填配置说明（最重要）

打开 `db_guardian/.env`，注意以下变量：

| 变量 | 说明 |
|------|------|
| `SECRET_KEY` | Django 密钥 |
| `ENCRYPTION_KEY` | **必须**，用于加密保存 MySQL 密码 |
| `DB_HOST/PORT/NAME/USER/PASSWORD` | PostgreSQL 连接 |
| `REDIS_CACHE_URL` | Redis 地址 |
| `CELERY_BROKER_URL` | Celery 连接 |

> 如果没有 `ENCRYPTION_KEY`，系统会拒绝启动。

### 8.1 生成 ENCRYPTION_KEY（示例）
在服务器上执行：
```bash
python - <<'PY'
import base64, os
print(base64.urlsafe_b64encode(os.urandom(32)).decode())
PY
```
把输出的字符串填入 `.env` 的 `ENCRYPTION_KEY=...`。

### 8.2 Docker 部署的默认数据库说明
使用 `docker compose` 时，PostgreSQL 和 Redis 会在容器中启动，`.env` 中的 `DB_HOST/REDIS` 通常是：
```
DB_HOST=postgres
DB_PORT=5432
REDIS_CACHE_URL=redis://redis:6379/0
```
如果你自行改动了 compose 的服务名或端口，需要同步修改 `.env`。

---

## 9. 功能使用指南（新手必读）

### 9.1 创建团队
登录后进入：**认证管理 → 团队 → 新增团队**

### 9.2 添加 MySQL 实例
进入：**实例列表 → 新增实例**

必须填写：
- 别名
- 主机 IP
- 端口
- 用户名 / 密码
- 团队
- 部署方式

#### 如果 MySQL 在 Docker 中：
- 填写 **容器名称**

#### 如果 MySQL 在系统服务：
- 填写 **服务名称**（如 `mysql` 或 `mysqld`）

#### 如果要启用监控/备份：
还需填写 SSH 信息（用于远程执行命令）：
- SSH 主机
- SSH 用户
- SSH 密码或密钥

---

## 10. 备份管理说明

### 8.1 备份策略
进入：**备份管理 → 备份策略 → 新增策略**

常用字段：
- 备份类型（全量/增量/热备/冷备）
- Cron 表达式（例如：`0 */6 * * *` 表示每 6 小时）
- 保留天数
- 存储位置

### 8.2 定时任务（一次性）
进入：**备份管理 → 定时任务 → 新增任务**

### 8.3 备份记录
查看所有已执行的备份，可以下载、验证或恢复。

### 8.4 恢复
- **从备份记录恢复**：直接点击“恢复”按钮
- **上传备份文件恢复**：手动上传 `.sql` / `.sql.gz`

---

## 11. SQL 终端使用说明
进入：**SQL 终端**

- 选择实例和数据库
- 输入 SQL
- 回车执行（Shift+Enter 换行）

执行历史会自动记录到 **SQL 执行历史**

---

## 12. 常见问题（FAQ）

### Q1: CPU/内存显示为 0？
A: 必须配置 SSH 登录信息，系统通过 SSH 采集监控。

### Q2: 备份失败提示 mysqldump 不存在？
A: Docker 镜像中需安装 `mariadb-client` 或 `mysql-client`。

### Q3: 热备/增量不工作？
A: 目标主机必须安装 `xtrabackup`。

---

## 13. 重要提示
- **务必保存 ENCRYPTION_KEY**
- 备份/恢复操作建议在测试库先试
- 生产建议使用 Linux + Docker 部署

---

如需进一步指导，请反馈错误信息或截图。
